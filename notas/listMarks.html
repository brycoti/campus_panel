<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Notas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

    <div class="max-w-4xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center text-blue-600 mb-8">Lista de Notas</h1>

        <!-- Botón para crear una nueva nota -->
        <div class="text-center mb-4">
            <button onclick="toggleCreateForm()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-500">
                Crear nueva nota
            </button>
        </div>

        <!-- Formulario para crear una nueva nota -->
        <div id="create-form" class="mb-6 hidden">
            <h2 class="text-xl text-center text-gray-800 mb-4">Crear nueva nota</h2>
            <form id="create-mark-form" class="space-y-4">
                <!-- Dropdown de Estudiantes -->
                <div>
                    <label for="student_id" class="block text-gray-700">Estudiante</label>
                    <select id="student_id" name="student_id" class="w-full px-4 py-2 border rounded" required>
                        <option value="">Seleccionar Estudiante</option>
                    </select>
                </div>
                
                <!-- Dropdown de Asignaturas -->
                <div>
                    <label for="subject_id" class="block text-gray-700">Asignatura</label>
                    <select id="subject_id" name="subject_id" class="w-full px-4 py-2 border rounded" required>
                        <option value="">Seleccionar Asignatura</option>
                    </select>
                </div>

                <!-- Nota -->
                <div>
                    <label for="mark" class="block text-gray-700">Nota</label>
                    <input type="number" id="mark" name="mark" class="w-full px-4 py-2 border rounded" min="0" max="10" required>
                </div>

                <div class="text-center">
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500">
                        Crear Nota
                    </button>
                </div>
            </form>
        </div>

        <!-- Sección de notas -->
        <section>
            <div id="mark-list" class="space-y-4">
                <!-- Las notas se cargarán aquí -->
            </div>
        </section>
    </div>

    <script>
        const apiUrl = 'http://127.0.0.1:8000/api';  // URL de tu API

        // Función para obtener los estudiantes
        async function fetchStudents() {
            try {
                const response = await fetch(`${apiUrl}/students`);
                const data = await response.json();

                const studentSelect = document.getElementById('student_id');
                studentSelect.innerHTML = '<option value="">Seleccionar Estudiante</option>';  // Limpiar el contenido

                data.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} ${student.surnames}`;
                    studentSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error al obtener estudiantes:', error);
            }
        }

        // Función para obtener las asignaturas
        async function fetchSubjects() {
            try {
                const response = await fetch(`${apiUrl}/subjects`);
                const data = await response.json();

                const subjectSelect = document.getElementById('subject_id');
                subjectSelect.innerHTML = '<option value="">Seleccionar Asignatura</option>';  // Limpiar el contenido

                data.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error al obtener asignaturas:', error);
            }
        }

        // Función para obtener todas las notas
        async function fetchMarks() {
            try {
                const response = await fetch(`${apiUrl}/marks`);
                const marks = await response.json();

                // Verifica si la respuesta contiene notas
                if (marks.length === 0) {
                    document.getElementById('mark-list').innerHTML = `<p class="text-center text-gray-600">No hay notas registradas.</p>`;
                } else {
                    renderMarks(marks);
                }
            } catch (error) {
                console.error('Error al obtener las notas:', error);
                document.getElementById('mark-list').innerHTML = `<p class="text-center text-red-600">Hubo un error al cargar las notas.</p>`;
            }
        }

        // Función para obtener los nombres de estudiantes y asignaturas a partir de los IDs
        // Función para obtener los nombres de estudiantes y asignaturas a partir de los IDs
async function getStudentAndSubjectNames(studentId, subjectId) {
    let studentName = '';
    let subjectName = '';

    try {
        // Obtener el estudiante por su ID
        const studentResponse = await fetch(`${apiUrl}/student/${studentId}`);
        const studentData = await studentResponse.json();
        studentName = studentData.student.name + ' ' + studentData.student.surnames;  // Acceso correcto al estudiante

        // Obtener la asignatura por su ID
        const subjectResponse = await fetch(`${apiUrl}/subject/${subjectId}`);
        const subjectData = await subjectResponse.json();
        subjectName = subjectData.subject.name;  // Acceso correcto a la asignatura
    } catch (error) {
        console.error('Error al obtener los nombres de estudiante y asignatura:', error);
    }

    return { studentName, subjectName };
}

        // Función para renderizar las notas con nombres
        async function renderMarks(marks) {
    const markList = document.getElementById('mark-list');
    markList.innerHTML = '';  // Limpiar lista antes de agregar nuevas notas

    for (const mark of marks) {
        // Obtener los nombres del estudiante y asignatura
        const { studentName, subjectName } = await getStudentAndSubjectNames(mark.student_id, mark.subject_id);

        const markDiv = document.createElement('div');
        markDiv.classList.add('p-4', 'bg-white', 'rounded', 'shadow', 'hover:bg-gray-50');
        markDiv.innerHTML = `
            <h3 class="font-semibold text-lg text-gray-800">Estudiante: ${studentName} - Asignatura: ${subjectName}</h3>
            <p class="text-gray-600">Nota: ${mark.mark}</p>
            <div class="mt-4 space-x-2">
                <!-- Ver nota -->
                <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500" onclick="showMark(${mark.id})">Ver</button>
                <!-- Actualizar nota -->
                <button class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-400" onclick="updateMark(${mark.id})">Actualizar</button>
                <!-- Eliminar nota -->
                <button class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-500" onclick="deleteMark(${mark.id})">Eliminar</button>
            </div>
        `;
        markList.appendChild(markDiv);
    }
}

        // Función para ver los detalles de una nota
        async function showMark(markId) {
            try {
                const response = await fetch(`${apiUrl}/mark/${markId}`);
                const data = await response.json();
                
                if (data.mark) {
                    alert(`Detalles de la nota:\nEstudiante: ${data.mark.student_id}\nAsignatura: ${data.mark.subject_id}\nNota: ${data.mark.mark}`);
                } else {
                    alert('Nota no encontrada.');
                }
            } catch (error) {
                console.error('Error al obtener los detalles de la nota:', error);
                alert('Hubo un error al cargar los detalles.');
            }
        }

        // Función para actualizar una nota
        async function updateMark(markId) {
            const updatedData = {
                student_id: prompt("Nuevo ID del Estudiante:"),
                subject_id: prompt("Nuevo ID de la Asignatura:"),
                mark: prompt("Nueva Nota:")
            };

            if (updatedData.student_id && updatedData.subject_id && updatedData.mark !== null) {
                try {
                    const response = await fetch(`${apiUrl}/mark/${markId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedData)
                    });

                    if (response.ok) {
                        alert('Nota actualizada correctamente');
                        fetchMarks(); // Recargar la lista de notas
                    } else {
                        alert('Error al actualizar la nota.');
                    }
                } catch (error) {
                    console.error('Error al actualizar la nota:', error);
                    alert('Hubo un error al actualizar.');
                }
            } else {
                alert('Por favor ingresa todos los datos.');
            }
        }

        // Función para eliminar una nota
        async function deleteMark(markId) {
            if (confirm('¿Estás seguro de que deseas eliminar esta nota?')) {
                try {
                    const response = await fetch(`${apiUrl}/mark/${markId}`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        alert('Nota eliminada correctamente');
                        fetchMarks(); // Recargar la lista de notas
                    } else {
                        alert('Error al eliminar la nota.');
                    }
                } catch (error) {
                    console.error('Error al eliminar la nota:', error);
                    alert('Hubo un error al eliminar.');
                }
            }
        }

        // Función para mostrar/ocultar el formulario de creación de nota
        function toggleCreateForm() {
            const form = document.getElementById('create-form');
            form.classList.toggle('hidden');
        }

        // Función para manejar el envío del formulario
        document.getElementById('create-mark-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const newMark = {
                student_id: document.getElementById('student_id').value,
                subject_id: document.getElementById('subject_id').value,
                mark: document.getElementById('mark').value
            };

            try {
                const response = await fetch(`${apiUrl}/mark`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newMark)
                });

                if (response.ok) {
                    alert('Nota creada correctamente');
                    fetchMarks(); // Recargar la lista de notas
                    toggleCreateForm(); // Ocultar el formulario
                } else {
                    alert('Error al crear la nota.');
                }
            } catch (error) {
                console.error('Error al crear la nota:', error);
                alert('Hubo un error al crear la nota.');
            }
        });

        // Cargar los estudiantes, asignaturas y notas cuando la página cargue
        window.onload = function() {
            fetchStudents();
            fetchSubjects();
            fetchMarks();
        };
    </script>
</body>
</html>
